name: Check for Dead Links

on:
  schedule:
    # Run every Sunday at 2:00 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch: # Allow manual trigger for testing

permissions:
  contents: read
  issues: write

jobs:
  check-links:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build site
        run: npm run build
      
      - name: Check for dead links
        id: link-check
        uses: lycheeverse/lychee-action@v2.0.2
        with:
          # Check all HTML files in the built site (lychee automatically reads .lycheeignore)
          args: --verbose --no-progress --accept 200,204,206,301,302,303,307,308,403 --timeout 20 --max-retries 3 --user-agent "Mozilla/5.0 (compatible; link-checker/1.0)" ./_site/**/*.html
          format: json
          output: ./lychee-report.json
          fail: false # Don't fail the workflow, we'll handle errors by creating issues
      
      - name: Process dead links and create issues
        if: steps.link-check.outputs.exit_code != 0
        uses: actions/github-script@v7
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Read the lychee report
            let report;
            try {
              const reportPath = path.join(process.env.GITHUB_WORKSPACE, 'lychee-report.json');
              const reportContent = fs.readFileSync(reportPath, 'utf8');
              report = JSON.parse(reportContent);
            } catch (error) {
              console.error('Failed to read lychee report:', error);
              return;
            }
            
            // Check if there are any failed links
            if (!report.fail_map || Object.keys(report.fail_map).length === 0) {
              console.log('No dead links found');
              return;
            }
            
            // Group dead links by source file
            const deadLinksByFile = {};
            for (const [url, sources] of Object.entries(report.fail_map)) {
              for (const source of sources) {
                // Clean up the source path
                const cleanSource = source.replace(/^\.?\/?_site\//, '');
                if (!deadLinksByFile[cleanSource]) {
                  deadLinksByFile[cleanSource] = [];
                }
                deadLinksByFile[cleanSource].push(url);
              }
            }
            
            // Check existing issues to avoid duplicates
            const existingIssues = await github.paginate(github.rest.issues.listForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'dead-link',
              state: 'open'
            });
            
            const existingIssueTitles = new Set(existingIssues.map(issue => issue.title));
            
            // Create issues for dead links
            const maxIssuesPerRun = 5; // Limit to prevent spam
            let issuesCreated = 0;
            
            for (const [file, urls] of Object.entries(deadLinksByFile)) {
              if (issuesCreated >= maxIssuesPerRun) {
                console.log(`Reached maximum of ${maxIssuesPerRun} issues per run`);
                break;
              }
              
              const issueTitle = `Dead links found in ${file}`;
              
              // Skip if issue already exists
              if (existingIssueTitles.has(issueTitle)) {
                console.log(`Issue already exists for ${file}, skipping`);
                continue;
              }
              
              // Create issue body with details
              let issueBody = `## Dead Links Detected\n\n`;
              issueBody += `The automated link checker found the following dead links in \`${file}\`:\n\n`;
              
              for (const url of urls) {
                // Get error details if available
                const errorDetails = report.detailed_report?.find(item => 
                  item.url === url && item.status === 'error'
                );
                
                issueBody += `- âŒ ${url}`;
                if (errorDetails?.reason) {
                  issueBody += ` - **Error:** ${errorDetails.reason}`;
                }
                issueBody += '\n';
              }
              
              issueBody += `\n### How to Fix\n\n`;
              issueBody += `1. Check if the URLs have permanently moved to a new location and update them\n`;
              issueBody += `2. If the content no longer exists, consider removing the links or finding alternatives\n`;
              issueBody += `3. For temporary issues, you can close this issue and it will be rechecked in the next weekly scan\n\n`;
              issueBody += `---\n`;
              issueBody += `*This issue was automatically created by the [dead link checker workflow](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/workflows/check-dead-links.yml)*\n`;
              issueBody += `*Run date: ${new Date().toISOString()}*`;
              
              // Create the issue
              try {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: issueTitle,
                  body: issueBody,
                  labels: ['dead-link', 'automated']
                });
                
                console.log(`Created issue for dead links in ${file}`);
                issuesCreated++;
              } catch (error) {
                console.error(`Failed to create issue for ${file}:`, error.message);
              }
            }
            
            // Create a summary issue if there are more dead links than we created issues for
            const totalFiles = Object.keys(deadLinksByFile).length;
            if (totalFiles > maxIssuesPerRun) {
              const summaryTitle = `Dead Link Summary - ${totalFiles} files affected`;
              
              if (!existingIssueTitles.has(summaryTitle)) {
                let summaryBody = `## Dead Link Check Summary\n\n`;
                summaryBody += `The automated link checker found dead links in **${totalFiles} files**.\n\n`;
                summaryBody += `Due to rate limiting, only ${maxIssuesPerRun} individual issues were created in this run.\n\n`;
                summaryBody += `### All Affected Files:\n\n`;
                
                for (const [file, urls] of Object.entries(deadLinksByFile)) {
                  summaryBody += `- \`${file}\` (${urls.length} dead link${urls.length > 1 ? 's' : ''})\n`;
                }
                
                summaryBody += `\n### Next Steps\n\n`;
                summaryBody += `1. Fix the issues created in this run\n`;
                summaryBody += `2. Manually trigger the workflow again to create issues for remaining files\n`;
                summaryBody += `3. Or wait for the next scheduled run\n\n`;
                summaryBody += `---\n`;
                summaryBody += `*This summary was automatically created by the [dead link checker workflow](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/workflows/check-dead-links.yml)*\n`;
                summaryBody += `*Run date: ${new Date().toISOString()}*`;
                
                try {
                  await github.rest.issues.create({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    title: summaryTitle,
                    body: summaryBody,
                    labels: ['dead-link', 'automated', 'summary']
                  });
                  
                  console.log('Created summary issue for all dead links');
                } catch (error) {
                  console.error('Failed to create summary issue:', error.message);
                }
              }
            }
            
            // Log summary to workflow
            const totalDeadLinks = Object.values(deadLinksByFile).flat().length;
            console.log(`\nðŸ“Š Dead Link Check Complete:`);
            console.log(`   - Total dead links found: ${totalDeadLinks}`);
            console.log(`   - Files affected: ${totalFiles}`);
            console.log(`   - Issues created: ${issuesCreated}`);
      
      - name: Upload link check results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: link-check-results
          path: |
            lychee-report.json
            lychee-action.log
          retention-days: 30