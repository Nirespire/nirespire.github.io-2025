name: Scaffold Monthly Newsletter

on:
  schedule:
    # Runs at 09:00 EST on the 1st of every month
    - cron: '0 14 1 * *'
  workflow_dispatch: # Allow manual runs
    inputs:
      month:
        description: 'Newsletter month (YYYY-MM format, e.g., 2026-02). Leave empty for current month.'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  scaffold-newsletter:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Determine newsletter month
        id: month
        run: |
          if [ -n "${{ github.event.inputs.month }}" ]; then
            NEWSLETTER_MONTH="${{ github.event.inputs.month }}"
          else
            # Default to current month
            NEWSLETTER_MONTH=$(date +%Y-%m)
          fi
          echo "newsletter_month=$NEWSLETTER_MONTH" >> $GITHUB_OUTPUT

          # Extract year and month name for branch naming
          YEAR=$(echo $NEWSLETTER_MONTH | cut -d'-' -f1)
          MONTH_NUM=$(echo $NEWSLETTER_MONTH | cut -d'-' -f2)
          MONTH_NAME=$(date -d "$NEWSLETTER_MONTH-01" +%B | tr '[:upper:]' '[:lower:]')
          echo "branch_name=newsletter/$YEAR-$MONTH_NUM-$MONTH_NAME" >> $GITHUB_OUTPUT
          echo "month_display=$MONTH_NAME $YEAR" >> $GITHUB_OUTPUT

      - name: Run scaffold newsletter script
        id: scaffold
        run: |
          if [ -n "${{ github.event.inputs.month }}" ]; then
            node scripts/scaffold-newsletter.js --month ${{ steps.month.outputs.newsletter_month }} --force
          else
            node scripts/scaffold-newsletter.js --force
          fi

          # Find the generated file
          NEWSLETTER_FILE=$(ls -t src/newsletter/*.md | head -1)
          echo "newsletter_file=$NEWSLETTER_FILE" >> $GITHUB_OUTPUT

      - name: Create branch and commit
        id: commit
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          BRANCH_NAME="${{ steps.month.outputs.branch_name }}"

          # Create and checkout new branch
          git checkout -b "$BRANCH_NAME"

          # Stage the new newsletter file
          git add src/newsletter/*.md

          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "changes_made=false" >> $GITHUB_OUTPUT
          else
            git commit -m "Draft: ${{ steps.month.outputs.month_display }} newsletter

Auto-generated newsletter draft featuring content from the previous month.

To complete this newsletter:
1. Update the subtitle and description in frontmatter
2. Write your retrospective prose
3. Add custom commentary for each read in the readCommentary section
4. Review and merge this PR when ready to publish"

            git push origin "$BRANCH_NAME"
            echo "changes_made=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.commit.outputs.changes_made == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          # Calculate content month (previous month)
          NEWSLETTER_MONTH="${{ steps.month.outputs.newsletter_month }}"
          CONTENT_MONTH=$(date -d "$NEWSLETTER_MONTH-01 -1 month" +"%B %Y")

          gh pr create \
            --title "Newsletter Draft: ${{ steps.month.outputs.month_display }}" \
            --body "## Monthly Newsletter Draft

Your **${{ steps.month.outputs.month_display }}** newsletter draft is ready for editing!

This newsletter features content from **$CONTENT_MONTH**.

### What's included
- Blog post from $CONTENT_MONTH (auto-populated in template)
- Reads from $CONTENT_MONTH with placeholder commentary
- Template structure with TODO markers

### Before merging
- [ ] Update the **subtitle** in frontmatter
- [ ] Update the **description** for SEO/social cards
- [ ] Write your **retrospective** prose (1-2 paragraphs)
- [ ] Replace **[TODO]** commentary with your insights for each read
- [ ] Remove any reads you don't want to include
- [ ] Preview locally with \`npm run dev\`

### Publishing
Once edits are complete, merge this PR to publish the newsletter.

---
*Auto-generated by the newsletter scaffolding workflow*" \
            --base main \
            --head "${{ steps.month.outputs.branch_name }}"

      - name: Summary
        if: steps.commit.outputs.changes_made == 'true'
        run: |
          echo "## Newsletter Draft Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Month:** ${{ steps.month.outputs.month_display }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ steps.month.outputs.branch_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**File:** \`${{ steps.scaffold.outputs.newsletter_file }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "A pull request has been created. Check your GitHub notifications!" >> $GITHUB_STEP_SUMMARY
